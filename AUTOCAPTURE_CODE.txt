// 在 sw.js 第11行后添加这一行
let isAutoCapturing = false;

// ===== 在文件最后(1120行后)添加以下所有代码 =====

// Message listener for popup communication
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.action === "getAutoCaptureStatus") {
    sendResponse({ isAutoCapturing });
    return true;
  }
  
  if (request.action === "startAutoCapture") {
    if (request.tabId) {
      startAutoCapture(request.tabId);
      sendResponse({ success: true });
    }
    return true;
  }
  
  if (request.action === "stopAutoCapture") {
    stopAutoCapture();
    sendResponse({ success: true });
    return true;
  }
});

function ensureAllAzimuthsChecked() {
  const labels = Array.from(document.querySelectorAll('.el-checkbox__label'));
  const targetLabel = labels.find(el => el.textContent.trim().includes('全部方位角'));
  
  if (targetLabel) {
    const checkbox = targetLabel.closest('.el-checkbox');
    if (checkbox) {
      const isChecked = checkbox.classList.contains('is-checked') || 
                        checkbox.querySelector('.is-checked') || 
                        checkbox.querySelector('input:checked');
      
      if (!isChecked) {
        console.log("[QuickShot] All Azimuths not checked. Clicking it now.");
        checkbox.click();
        return true; 
      } else {
        console.log("[QuickShot] All Azimuths is already checked.");
      }
    }
  } else {
    console.warn("[QuickShot] Could not find All Azimuths checkbox.");
  }
  return false;
}

async function startAutoCapture(tabId) {
  if (isAutoCapturing) {
    console.log("[QuickShot] Auto-capture already running");
    return;
  }
  
  isAutoCapturing = true;
  console.log("[QuickShot] Starting auto-capture...");
  
  try {
    await autoCaptureLoop(tabId);
  } catch (error) {
    console.error("[QuickShot] Auto-capture error:", error);
  } finally {
    isAutoCapturing = false;
    console.log("[QuickShot] Auto-capture stopped");
  }
}

function stopAutoCapture() {
  isAutoCapturing = false;
  console.log("[QuickShot] Stopping auto-capture...");
}

async function autoCaptureLoop(tabId) {
  let imageCount = 0;
  
  while (isAutoCapturing) {
    console.log(`[QuickShot] Capturing image ${imageCount + 1}...`);
    
    await runCapture(tabId);
    imageCount++;
    
    await sleep(1000);
    
    const [isLast] = await chrome.scripting.executeScript({
      target: { tabId, allFrames: true },
      func: checkIfLastImage,
    });
    
    if (isLast?.result) {
      console.log("[QuickShot] Reached last image!");
      break;
    }
    
    const [clicked] = await chrome.scripting.executeScript({
      target: { tabId, allFrames: true },
      func: clickNextButton,
    });
    
    if (!clicked?.result) {
      console.warn("[QuickShot] Could not find next button.");
      break;
    }
    
    await sleep(1500);
  }
  
  console.log(`[QuickShot] Completed! Captured ${imageCount} images.`);
}

function clickNextButton() {
  const selectors = [
    ".el-carousel__arrow--right",
    "button[class*='arrow-right']",
    ".swiper-button-next",
    ".btn-next"
  ];

  function isVisible(el) {
    if (!el) return false;
    const style = window.getComputedStyle(el);
    if (style.display === 'none' || style.visibility === 'hidden') return false;
    const rect = el.getBoundingClientRect();
    return rect.width > 0 && rect.height > 0;
  }

  for (const selector of selectors) {
    const els = document.querySelectorAll(selector);
    for (const el of els) {
      if (isVisible(el) && !el.disabled) {
        el.click();
        return true;
      }
    }
  }

  const allButtons = Array.from(document.querySelectorAll('button, a, [role="button"]'));
  for (const btn of allButtons) {
    const text = (btn.innerText || '').trim();
    if ((text === '>' || text.includes('下一张')) && isVisible(btn) && !btn.disabled) {
      btn.click();
      return true;
    }
  }

  return false;
}

function checkIfLastImage() {
  if (document.body.innerText.includes("已经是最后一张了")) {
    return true;
  }

  const toasts = document.querySelectorAll('.el-message__content, .toast');
  for (const toast of toasts) {
    if (toast.textContent.includes("已经是最后一张")) {
      return true;
    }
  }

  const nextBtns = document.querySelectorAll('.el-carousel__arrow--right, .btn-next');
  for (const btn of nextBtns) {
    if (btn.disabled) return true;
  }

  return false;
}
