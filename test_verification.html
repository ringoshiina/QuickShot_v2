<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>Regex Verification Test</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        .test-case {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }

        .result {
            margin-top: 10px;
            font-weight: bold;
        }

        .pass {
            color: green;
        }

        .fail {
            color: red;
        }
    </style>
</head>

<body>
    <h1>Regex Verification Test</h1>
    <div id="output"></div>

    <!-- Mock DOM for Test Case 1: Standard F25NC005-01 -->
    <div id="mock-dom-1" style="display:none">
        <div>
            <span title="项目编号：F25NC005">项目编号：F25NC005</span>
            <span title="地块编号：F25NC005-01">地块编号：F25NC005-01</span>
            <span>当前：1/5</span>
        </div>
    </div>

    <!-- Mock DOM for Test Case 2: Two-letter prefix FG25NC005-02 -->
    <div id="mock-dom-2" style="display:none">
        <div>
            <div aria-label="项目编号">FG25NC005</div>
            <div aria-label="地块编号">FG25NC005-02</div>
            <input type="text" value="3" aria-label="当前序号">
            <span>共 10 张</span>
        </div>
    </div>

    <script>
        // --- Paste scrapeContext logic here (modified to return result directly) ---
        function scrapeContext(root) {
            const ratioPattern = /(\d+)\s*[/\uFF0F]\s*(\d+)/;
            const ratioPatternGlobal = /(\d+)\s*[/\uFF0F]\s*(\d+)/g;
            const indexHintPattern = /(?:序号|当前|index|sequence)/i;
            // UPDATED REGEX PATTERNS
            const parcelPattern = /[A-Z]{1,2}\d{2}[A-Z0-9]+-\d+/;
            const parcelPatternGlobal = /[A-Z]{1,2}\d{2}[A-Z0-9]+-\d+/g;
            const projectPattern = /\b[A-Z]{1,2}\d{2}[A-Z0-9]+\b/;

            function readParcelId(root) {
                if (!root) return '';
                const byText = root.innerText || '';
                const textMatch = byText.match(parcelPattern);
                if (textMatch) return textMatch[0];

                const selectors = ['[title*="地块编号"], [title*="地块编号："], [data-field*="地块"], [aria-label*="地块编号"]'];
                for (const selector of selectors) {
                    const el = root.querySelector(selector);
                    if (!el) continue;
                    const t = el.textContent || el.getAttribute('title') || '';
                    const match = t.match(parcelPattern);
                    if (match) return match[0];
                }
                return '';
            }

            function readProjectId(root) {
                if (!root) return '';
                const byText = root.innerText || '';
                const textMatch = byText.match(projectPattern);
                if (textMatch) return textMatch[0];

                const selectors = ['[title*="项目编号"], [aria-label*="项目编号"], [data-field*="项目编号"]'];
                for (const selector of selectors) {
                    const el = root.querySelector(selector);
                    if (!el) continue;
                    const t = el.textContent || el.getAttribute('title') || '';
                    const matchSel = t.match(projectPattern);
                    if (matchSel) return matchSel[0];
                }
                return '';
            }

            // Simplified for test
            function readCurrentIndex(root) {
                const byText = root.innerText || '';
                const ratio = byText.match(ratioPattern);
                if (ratio) return parseInt(ratio[1], 10);
                const input = root.querySelector('input');
                if (input) return parseInt(input.value, 10);
                return 0;
            }

            return {
                parcelId: readParcelId(root),
                projectId: readProjectId(root),
                current: readCurrentIndex(root)
            };
        }

        // --- Test Runner ---
        const output = document.getElementById('output');

        function runTest(id, name, expectedParcel, expectedProject) {
            const root = document.getElementById(id);
            const result = scrapeContext(root);
            const div = document.createElement('div');
            div.className = 'test-case';

            const parcelPass = result.parcelId === expectedParcel;
            const projectPass = result.projectId === expectedProject;
            const allPass = parcelPass && projectPass;

            div.innerHTML = `
                <strong>${name}</strong><br>
                Expected Parcel: ${expectedParcel} | Actual: ${result.parcelId} <span class="${parcelPass ? 'pass' : 'fail'}">${parcelPass ? 'PASS' : 'FAIL'}</span><br>
                Expected Project: ${expectedProject} | Actual: ${result.projectId} <span class="${projectPass ? 'pass' : 'fail'}">${projectPass ? 'PASS' : 'FAIL'}</span>
            `;
            output.appendChild(div);
        }

        runTest('mock-dom-1', 'Test Case 1: F25NC005-01 (Single Letter Prefix)', 'F25NC005-01', 'F25NC005');
        runTest('mock-dom-2', 'Test Case 2: FG25NC005-02 (Double Letter Prefix)', 'FG25NC005-02', 'FG25NC005');

    </script>
</body>

</html>